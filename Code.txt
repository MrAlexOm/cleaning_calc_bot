# -- coding: utf-8 --
import telebot
from telebot import types
from telebot.storage import StateMemoryStorage

# ---------- CONFIG ----------
# –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –¢–û–ö–ï–ù
TOKEN = "8162969073:AAFH5BPDIWNHqVuzfzbHrqFZsBTxIsmYpK4" 
ADMIN_ID = 6181649972 # ID –∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∑–∞—è–≤–∫–∏
WHATSAPP_LINK = "https://wa.me/905344202379"

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
MIN_TRAVEL_PER_PERSON = 1200  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–µ–∑–¥–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞ [cite: 18]
HOURLY_RATE = 450             # –¶–µ–Ω–∞ –∑–∞ —á–∞—Å (–ø–æ—á–∞—Å–æ–≤–∞—è) [cite: 16]
DISTANCE_FEE = {"–ö–µ–º–µ—Ä": 500, "–ë–µ–ª–µ–∫": 500, "–ê–Ω—Ç–∞–ª—å—è": 0} # –î–æ–ø–ª–∞—Ç–∞ –∑–∞ —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å [cite: 10, 11]
MAX_DISCOUNT_TL = 1500        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –≤ –ª–∏—Ä–∞—Ö [cite: 41]

# ---------- PRICES (–¢–∞–±–ª–∏—Ü–∞ —Ü–µ–Ω –∏–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏) ----------
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞: "–¢–∏–ø –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏": {"–¢–∏–ø —É–±–æ—Ä–∫–∏": –¶–µ–Ω–∞}
# –î–∞–Ω–Ω—ã–µ –≤–∑—è—Ç—ã –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ 

PRICES = {
    "1+0": {
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 1400, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 1800, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 1400, "VIP": 3000, 
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 2800 # (–ì–µ–Ω * 2)
    },
    "1+1": {
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 1800, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 2600, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 3200, "VIP": 4000,
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 6400
    },
    "2+1_low": { # < 100 –∫–≤.–º
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 2200, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 3200, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 3900, "VIP": 5600,
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 7800
    },
    "2+1_high": { # > 100 –∫–≤.–º
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 2600, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 3800, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 4500, "VIP": 6200,
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 9000
    },
    "3+1": {
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 3200, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 4300, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 5300, "VIP": 7800,
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 10600
    },
    "4+1": {
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 3900, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 5000, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 6500, "VIP": 8800,
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 13000
    },
    "5+1": {
        "–≠–∫—Å–ø—Ä–µ—Å—Å": 4800, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 7000, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 9000, "VIP": 12900,
        "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 18000
    },
    # –î–ª—è 6+1 –∏ 7+1 —Ü–µ–Ω—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã —è–≤–Ω–æ –≤ –ø—Ä–∞–π—Å–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫–∏ –∏–ª–∏ –ª–æ–≥–∏–∫—É "–ø–æ –∑–∞–ø—Ä–æ—Å—É"
    "6+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": 0, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 0, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 0, "VIP": 0, "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 0},
    "7+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": 0, "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": 0, "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": 0, "VIP": 0, "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 0}
}

# –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ –∫–ª–∏–Ω–µ—Ä–æ–≤ –∏ —á–∞—Å–æ–≤ (Layout -> Type -> (Cleaners, Hours))
# [cite: 42, 43]
RECOMM_TABLE = {
    "1+0": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (1, 1.5), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (1, 2), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (1, 3), "VIP": (1, 4)},
    "1+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (1, 2), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (1, 3), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (1, 4), "VIP": (1, 5)},
    "2+1_low": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (1, 3), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (1, 4), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (1, 6), "VIP": (1, 7)},
    "2+1_high": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (1, 3), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (1, 4), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (1, 6), "VIP": (1, 7)},
    "3+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (1, 4), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (2, 4), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (2, 4), "VIP": (2, 6)},
    "4+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (2, 4), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (2, 5), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (2, 6), "VIP": (3, 6)},
    "5+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (2, 5), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (2, 7), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (3, 5), "VIP": (3, 8)},
    "6+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (2, 8), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (3, 7), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (3, 6), "VIP": (4, 8)},
    "7+1": {"–≠–∫—Å–ø—Ä–µ—Å—Å": (2, 8), "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è": (3, 7), "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è": (3, 6), "VIP": (4, 8)}
}

# ---------- EXTRAS ----------
# [cite: 38-40]
EXTRAS = {
    "—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–∫–Ω–∞ (1 —Å—Ç–≤–æ—Ä–∫–∞)": {"price": 100, "time": 6},
    "–ø–∞–Ω–æ—Ä–∞–º–Ω—ã–µ –æ–∫–Ω–∞ (1 —Å—Ç–≤–æ—Ä–∫–∞)": {"price": 190, "time": 7.5},
    "–æ—Å—Ç–µ–∫–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ø–µ—Ç–∞ (1 –º)": {"price": 150, "time": 10},
    "–º–æ–π–∫–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞": {"price": 500, "time": 60}, # —Å –º–æ—Ä–æ–∑–∏–ª–∫–æ–π
    "–º–æ–π–∫–∞ –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã": {"price": 200, "time": 30},
    "–º–æ–π–∫–∞ –¥—É—Ö–æ–≤–∫–∏": {"price": 500, "time": 60},
    "–º–æ–π–∫–∞ –ø–æ—Å—É–¥–æ–º–æ–π–∫–∏": {"price": 200, "time": 30},
    "–º–æ–π–∫–∞ —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã": {"price": 150, "time": 30},
    "–º–æ–π–∫–∞ –ª–µ—Å—Ç–Ω–∏—á–Ω–æ–≥–æ –ø—Ä–æ–ª–µ—Ç–∞": {"price": 400, "time": 60},
    "—à—Ç–æ—Ä—ã —Å–Ω—è—Ç—å+–ø–æ—Å—Ç–∏—Ä–∞—Ç—å+–ø–æ–≤–µ—Å–∏—Ç—å (1–º)": {"price": 100, "time": 6},
    "–≥–ª–∞–∂–∫–∞ (1 —á–∞—Å)": {"price": 400, "time": 60},
    "–ø–∞—Ä–æ–≤–∞—è —à–≤–∞–±—Ä–∞ (1 –∫–≤.–º.)": {"price": 30, "time": 0.5},
    "—Å–∞–Ω—É–∑–µ–ª": {"price": 0, "time": 0}, # –í–∫–ª—é—á–µ–Ω—ã –≤ –±–∞–∑—É
    "–±–∞–ª–∫–æ–Ω": {"price": 0, "time": 0}   # –í–∫–ª—é—á–µ–Ω—ã –≤ –±–∞–∑—É
}

# Mapping –¥–ª—è –≤–≤–æ–¥–∞ —á–∏—Å–µ–ª
NUM_EXTRA_KEYS = {
    "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–∫–Ω–∞ (–≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ —Å—Ç–≤–æ—Ä–æ–∫)": "—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–∫–Ω–∞ (1 —Å—Ç–≤–æ—Ä–∫–∞)",
    "–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–µ –æ–∫–Ω–∞ (–≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ —Å—Ç–≤–æ—Ä–æ–∫)": "–ø–∞–Ω–æ—Ä–∞–º–Ω—ã–µ –æ–∫–Ω–∞ (1 —Å—Ç–≤–æ—Ä–∫–∞)",
    "–û—Å—Ç–µ–∫–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ø–µ—Ç–∞ (–≤–≤–µ—Å—Ç–∏ –º.–ø.)": "–æ—Å—Ç–µ–∫–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ø–µ—Ç–∞ (1 –º)",
    "–ú–æ–π–∫–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ (—à—Ç)": "–º–æ–π–∫–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞",
    "–ú–æ–π–∫–∞ –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã (—à—Ç)": "–º–æ–π–∫–∞ –º–æ—Ä–æ–∑–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã",
    "–ú–æ–π–∫–∞ –¥—É—Ö–æ–≤–∫–∏ (—à—Ç)": "–º–æ–π–∫–∞ –¥—É—Ö–æ–≤–∫–∏",
    "–ú–æ–π–∫–∞ –ø–æ—Å—É–¥–æ–º–æ–π–∫–∏ (—à—Ç)": "–º–æ–π–∫–∞ –ø–æ—Å—É–¥–æ–º–æ–π–∫–∏",
    "–ú–æ–π–∫–∞ —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã (—à—Ç)": "–º–æ–π–∫–∞ —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã",
    "–ú–æ–π–∫–∞ –ª–µ—Å—Ç–Ω–∏—á–Ω–æ–≥–æ –ø—Ä–æ–ª–µ—Ç–∞ (—à—Ç)": "–º–æ–π–∫–∞ –ª–µ—Å—Ç–Ω–∏—á–Ω–æ–≥–æ –ø—Ä–æ–ª–µ—Ç–∞",
    "–®—Ç–æ—Ä—ã —Å–Ω—è—Ç—å+–ø–æ—Å—Ç–∏—Ä–∞—Ç—å+–ø–æ–≤–µ—Å–∏—Ç—å (–≤–≤–µ—Å—Ç–∏ –º)": "—à—Ç–æ—Ä—ã —Å–Ω—è—Ç—å+–ø–æ—Å—Ç–∏—Ä–∞—Ç—å+–ø–æ–≤–µ—Å–∏—Ç—å (1–º)",
    "–ì–ª–∞–∂–∫–∞ (–≤–≤–µ—Å—Ç–∏ —á–∞—Å—ã)": "–≥–ª–∞–∂–∫–∞ (1 —á–∞—Å)",
    "–ü–∞—Ä–æ–≤–∞—è —à–≤–∞–±—Ä–∞ (–≤–≤–µ—Å—Ç–∏ –∫–≤.–º.)": "–ø–∞—Ä–æ–≤–∞—è —à–≤–∞–±—Ä–∞ (1 –∫–≤.–º.)",
}

storage = StateMemoryStorage()
bot = telebot.TeleBot(TOKEN, state_storage=storage)
SESS = {} # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–≤ –∏–¥–µ–∞–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö)

# ---------- –õ–û–ì–ò–ö–ê ----------

def get_real_layout_key(layout, area, kitchen_isolated):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º –ø–ª–æ—â–∞–¥–∏ –∏ –∫—É—Ö–Ω–∏."""
    # 1. –ï—Å–ª–∏ –∫—É—Ö–Ω—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç –Ω–∞ 1
    # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: 1+0 —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫—É—Ö–Ω–µ–π –æ–±—ã—á–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 1+1
    temp_layout = layout
    if kitchen_isolated and layout != "1+0":
        try:
            rooms = int(layout.split("+")[0])
            temp_layout = f"{rooms + 1}+1"
        except:
            pass
    elif kitchen_isolated and layout == "1+0":
        temp_layout = "1+1"

    # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ 2+1 (–ø–ª–æ—â–∞–¥—å)
    if temp_layout == "2+1":
        return "2+1_low" if area == "<100 –º¬≤" else "2+1_high"
    
    # 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ after increment –º—ã –ø–æ–ª—É—á–∏–ª–∏ layout –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç (–Ω–∞–ø—Ä 8+1)
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å, —Ü–µ–Ω–∞ –±—É–¥–µ—Ç 0 (–ø–æ –∑–∞–ø—Ä–æ—Å—É)
    return temp_layout

def calculate_total(chat_id):
    data = SESS.get(chat_id, {})
    city = data.get("city", "–ê–Ω—Ç–∞–ª—å—è")
    service = data.get("service_type")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑—É
    layout_key = get_real_layout_key(data["layout"], data.get("area"), data.get("kitchen_isolated"))
    
    base_price = 0
    if service == "–ü–æ—á–∞—Å–æ–≤–∞—è":
        # –î–ª—è –ø–æ—á–∞—Å–æ–≤–æ–π: –±–µ—Ä–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç (1 —á–µ–ª 3 —á–∞—Å–∞)
        # –ï—Å–ª–∏ –±—ã –±—ã–ª–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è –ø–æ—á–∞—Å–æ–≤–∞—è - –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ª–æ–≥–∏–∫–∞
        rec_cleaners, rec_hours = 1, 3 # –î–µ—Ñ–æ–ª—Ç
        base_price = rec_cleaners * rec_hours * HOURLY_RATE
    else:
        # –ë–µ—Ä–µ–º –∏–∑ —Ç–∞–±–ª–∏—Ü—ã PRICES
        if layout_key in PRICES:
            base_price = PRICES[layout_key].get(service, 0)
        else:
            # –ï—Å–ª–∏ layout —Å—Ç–∞–ª 3+1 (–∏–∑ 2+1)
            if layout_key in PRICES:
                 base_price = PRICES[layout_key].get(service, 0)
            else:
                 base_price = 0 # –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ª—É—á–∞–π

    # –î–æ–ø —É—Å–ª—É–≥–∏
    extras_price = 0
    extras_time_add = 0
    for name, qty in data.get("extras", []):
        if name in EXTRAS:
            extras_price += EXTRAS[name]["price"] * qty
            extras_time_add += EXTRAS[name]["time"] * qty

    # –°–∫–∏–¥–∫–∏
    total_before_discount = base_price + extras_price
    discounts = data.get("discounts_selected", {})
    percent = 0
    if discounts.get("first_order"): percent += 10
    if discounts.get("second_order"): percent += 10
    if discounts.get("provide_vac"): percent += 5
    if discounts.get("provide_cleaners"): percent += 5
    
    discount_amount = (total_before_discount * percent) / 100
    if discount_amount > MAX_DISCOUNT_TL:
        discount_amount = MAX_DISCOUNT_TL

    # –í—ã–µ–∑–¥ –∑–∞ –≥–æ—Ä–æ–¥ (—Å—á–∏—Ç–∞–µ–º –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞)
    # –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–µ–º –∫–æ–ª-–≤–æ –ª—é–¥–µ–π
    rec_cleaners = 1
    rec_hours = 0
    
    # Lookup recommended
    base_layout_key = layout_key # –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–π layout
    if base_layout_key in RECOMM_TABLE and service in RECOMM_TABLE[base_layout_key]:
        rec_cleaners, base_h = RECOMM_TABLE[base_layout_key][service]
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ–ø–æ–≤, —Ä–∞—Å–∫–∏–¥–∞–Ω–Ω–æ–µ –Ω–∞ –∫–ª–∏–Ω–µ—Ä–æ–≤
        rec_hours = base_h + (extras_time_add / 60 / rec_cleaners)
    else:
        rec_cleaners, rec_hours = 1, 3 # Fallback

    distance_fee = DISTANCE_FEE.get(city, 0) * rec_cleaners
    
    # –ò—Ç–æ–≥–æ
    total = (base_price + extras_price - discount_amount) + distance_fee
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–µ–∑–¥
    min_order = MIN_TRAVEL_PER_PERSON * rec_cleaners
    if total < min_order:
        total = min_order

    return {
        "base": int(base_price),
        "extras": int(extras_price),
        "dist_fee": int(distance_fee),
        "discount": int(discount_amount),
        "total": int(total),
        "rec_cleaners": rec_cleaners,
        "rec_hours": round(rec_hours, 1),
        "percent": percent
    }

# ---------- HANDLERS ----------

@bot.message_handler(commands=["start"])
def handle_start(m):
    SESS[m.chat.id] = {"step": "city", "extras": [], "discounts_selected": {}}
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("–°–¢–ê–†–¢", "–ü—Ä–∞–≤–∏–ª–∞")
    bot.send_message(m.chat.id, "üëã –ü—Ä–∏–≤–µ—Ç! –Ø **–ß–∏—Å—Ç—é–ª—è** ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ CleanTeam.\n–î–∞–≤–∞–π —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–±–æ—Ä–∫–∏!", parse_mode="Markdown", reply_markup=kb)

@bot.message_handler(func=lambda m: m.text == "–ü—Ä–∞–≤–∏–ª–∞")
def handle_rules(m):
    text = (
        "üìú *–ü—Ä–∞–≤–∏–ª–∞ –∏ —É—Å–ª–æ–≤–∏—è:*\n\n"
        "‚Ä¢ üê∂ –£–±–æ—Ä–∫–∞ —à–µ—Ä—Å—Ç–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö ‚Äî –¥–æ–ø–ª–∞—Ç–∞ +200‚Ç∫.\n"
        "‚Ä¢ üí≥ –û–ø–ª–∞—Ç–∞: –Ω–∞–ª–∏—á–Ω—ã–µ (TRY), IBAN, USDT.\n"
        "‚Ä¢ ‚ùå –û—Ç–º–µ–Ω–∞: –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∑–∞ 14—á. –ú–µ–Ω–µ–µ 14—á ‚Äî —à—Ç—Ä–∞—Ñ 1000‚Ç∫.\n"
        "‚Ä¢ ‚è± –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –¥–æ 8 —á–∞—Å–æ–≤.\n"
        "‚Ä¢ üöï –ú–∏–Ω. –≤—ã–µ–∑–¥: 1200‚Ç∫/—á–µ–ª (–ê–Ω—Ç–∞–ª—å—è), 1500‚Ç∫/—á–µ–ª (–∑–∞ –≥–æ—Ä–æ–¥).\n"
        "‚Ä¢ üîç –ü—Ä–∏–µ–º–∫–∞ —Ä–∞–±–æ—Ç—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.\n\n"
        "[cite: 51, 52]"
    )
    bot.send_message(m.chat.id, text, parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text == "–°–¢–ê–†–¢")
def start_process(m):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("–ê–Ω—Ç–∞–ª—å—è", "–ö–µ–º–µ—Ä", "–ë–µ–ª–µ–∫")
    kb.add("–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–æ–º")
    bot.send_message(m.chat.id, "üìç –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", reply_markup=kb)

@bot.message_handler(func=lambda m: m.text in ["–ê–Ω—Ç–∞–ª—å—è", "–ö–µ–º–µ—Ä", "–ë–µ–ª–µ–∫"])
def city_chosen(m):
    SESS[m.chat.id]["city"] = m.text
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    kb.add("–≠–∫—Å–ø—Ä–µ—Å—Å", "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è", "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è", "VIP", "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞", "–ü–æ—á–∞—Å–æ–≤–∞—è")
    bot.send_message(m.chat.id, f"–ì–æ—Ä–æ–¥: {m.text}\nüßπ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–±–æ—Ä–∫–∏:", reply_markup=kb)

@bot.message_handler(func=lambda m: m.text in ["–≠–∫—Å–ø—Ä–µ—Å—Å", "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è", "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è", "VIP", "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞", "–ü–æ—á–∞—Å–æ–≤–∞—è"])
def type_chosen(m):
    SESS[m.chat.id]["service_type"] = m.text
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=3)
    kb.add("1+0", "1+1", "2+1", "3+1", "4+1", "5+1", "6+1", "7+1")
    bot.send_message(m.chat.id, "üè† –£–∫–∞–∂–∏—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É:", reply_markup=kb)

@bot.message_handler(func=lambda m: m.text in ["1+0","1+1","2+1","3+1","4+1","5+1","6+1","7+1"])
def layout_chosen(m):
    chat = m.chat.id
    SESS[chat]["layout"] = m.text
    
    if m.text == "2+1":
        kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
        kb.add("<100 –º¬≤", ">100 –º¬≤")
        bot.send_message(chat, "üìê –£—Ç–æ—á–Ω–∏—Ç–µ –ø–ª–æ—â–∞–¥—å:", reply_markup=kb)
    else:
        ask_kitchen(chat)

@bot.message_handler(func=lambda m: m.text in ["<100 –º¬≤", ">100 –º¬≤"])
def area_chosen(m):
    SESS[m.chat.id]["area"] = m.text
    ask_kitchen(m.chat.id)

def ask_kitchen(chat_id):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("–î–∞, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "–ù–µ—Ç, —Å–æ–≤–º–µ—â–µ–Ω–Ω–∞—è")
    bot.send_message(chat_id, "üçΩ –ö—É—Ö–Ω—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è? (–≠—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –¥–æ–ø. –∫–æ–º–Ω–∞—Ç–∞)", reply_markup=kb)

@bot.message_handler(func=lambda m: m.text in ["–î–∞, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "–ù–µ—Ç, —Å–æ–≤–º–µ—â–µ–Ω–Ω–∞—è"])
def kitchen_chosen(m):
    SESS[m.chat.id]["kitchen_isolated"] = (m.text == "–î–∞, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è")
    bot.send_message(m.chat.id, "üöΩ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–Ω—É–∑–ª–æ–≤ (–Ω–∞–ø–∏—à–∏—Ç–µ —á–∏—Å–ª–æ):", reply_markup=types.ReplyKeyboardRemove())
    SESS[m.chat.id]["step"] = "bathrooms"

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "bathrooms")
def bathrooms_input(m):
    if not m.text.isdigit():
        bot.send_message(m.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—É.")
        return
    SESS[m.chat.id]["bathrooms"] = int(m.text)
    bot.send_message(m.chat.id, "üåÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–∫–æ–Ω–æ–≤ (–Ω–∞–ø–∏—à–∏—Ç–µ —á–∏—Å–ª–æ):")
    SESS[m.chat.id]["step"] = "balconies"

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "balconies")
def balconies_input(m):
    if not m.text.isdigit():
        bot.send_message(m.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—É.")
        return
    SESS[m.chat.id]["balconies"] = int(m.text)
    show_extras_menu(m.chat.id)

def show_extras_menu(chat_id):
    SESS[chat_id]["step"] = "extras"
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    for key in NUM_EXTRA_KEYS:
        kb.add(key)
    kb.add("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±–æ—Ä –æ–ø—Ü–∏–π")
    bot.send_message(chat_id, "‚ûï –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:", reply_markup=kb)

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "extras")
def extras_handler(m):
    chat = m.chat.id
    txt = m.text
    
    if txt == "‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±–æ—Ä –æ–ø—Ü–∏–π":
        show_discounts(chat)
        return

    if txt in NUM_EXTRA_KEYS:
        SESS[chat]["await_extra"] = NUM_EXTRA_KEYS[txt]
        bot.send_message(chat, f"–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è '{txt}' (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):", reply_markup=types.ReplyKeyboardRemove())
        SESS[chat]["step"] = "enter_extra_qty"

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "enter_extra_qty")
def extra_qty_handler(m):
    chat = m.chat.id
    if not m.text.isdigit():
        bot.send_message(chat, "–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ.")
        return
    
    qty = int(m.text)
    extra_name = SESS[chat].pop("await_extra")
    SESS[chat]["extras"].append((extra_name, qty))
    
    bot.send_message(chat, f"üëå –î–æ–±–∞–≤–ª–µ–Ω–æ: {extra_name} x {qty}")
    show_extras_menu(chat)

def show_discounts(chat_id):
    SESS[chat_id]["step"] = "discounts"
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ -10%", "–ö–∞–∂–¥—ã–π –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑ -10%")
    kb.add("–°–≤–æ–π –ø—ã–ª–µ—Å–æ—Å/–≤–µ–¥—Ä–æ -5%", "–°–≤–æ—è —Ö–∏–º–∏—è -5%")
    kb.add("‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å—á–µ—Ç—É")
    bot.send_message(chat_id, "üéÅ –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–¥–∫–∏ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):", reply_markup=kb)

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "discounts")
def discount_handler(m):
    chat = m.chat.id
    txt = m.text
    sel = SESS[chat]["discounts_selected"]
    
    if txt == "–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ -10%": sel["first_order"] = True
    elif txt == "–ö–∞–∂–¥—ã–π –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑ -10%": sel["second_order"] = True
    elif txt == "–°–≤–æ–π –ø—ã–ª–µ—Å–æ—Å/–≤–µ–¥—Ä–æ -5%": sel["provide_vac"] = True
    elif txt == "–°–≤–æ—è —Ö–∏–º–∏—è -5%": sel["provide_cleaners"] = True
    elif txt == "‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å—á–µ—Ç—É":
        finalize_calc(chat)
        return
    else:
        bot.send_message(chat, "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–∫–∏–¥–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–∞—Å—á–µ—Ç—É.")
        return
    
    bot.send_message(chat, f"‚úÖ –£—á—Ç–µ–Ω–æ: {txt}")

def finalize_calc(chat_id):
    res = calculate_total(chat_id)
    SESS[chat_id]["result"] = res
    
    data = SESS[chat_id]
    extras_str = "\n".join([f"- {n}: {q} —à—Ç/–º" for n, q in data["extras"]]) if data["extras"] else "–ù–µ—Ç"
    
    msg = (
        f"üìã *–ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢*\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üèô –ì–æ—Ä–æ–¥: {data['city']}\n"
        f"üßπ –¢–∏–ø: {data['service_type']}\n"
        f"üè† –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: {data['layout']} {data.get('area','')}\n"
        f"üçΩ –ö—É—Ö–Ω—è –∏–∑–æ–ª–∏—Ä.: {'–î–∞' if data['kitchen_isolated'] else '–ù–µ—Ç'}\n"
        f"üõÅ –°–∞–Ω—É–∑–ª—ã: {data['bathrooms']}, –ë–∞–ª–∫–æ–Ω—ã: {data['balconies']}\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üíµ –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {res['base']} TL\n"
        f"‚ûï –î–æ–ø. —É—Å–ª—É–≥–∏: {res['extras']} TL\n"
        f"üöï –í—ã–µ–∑–¥/–£–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å: {res['dist_fee']} TL\n"
        f"üè∑ –°–∫–∏–¥–∫–∞: -{res['discount']} TL ({res['percent']}%)\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üí∞ *–ò–¢–û–ì–û: ~{res['total']} TL*\n\n"
        f"üë• *–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º:* {res['rec_cleaners']} –∫–ª–∏–Ω–µ—Ä–∞(–æ–≤) –Ω–∞ ~{res['rec_hours']} —á.\n\n"
        f"üìù *–í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏:*\n{extras_str}\n\n"
        f"‚ÑπÔ∏è _–¶–µ–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è. –ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –º–µ—Å—Ç–µ._"
    )
    
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É", "üîÑ –í –º–µ–Ω—é")
    bot.send_message(chat_id, msg, parse_mode="Markdown", reply_markup=kb)

@bot.message_handler(func=lambda m: m.text == "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É")
def ask_contact(m):
    SESS[m.chat.id]["step"] = "contact"
    bot.send_message(m.chat.id, "üìû –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä WhatsApp –¥–ª—è —Å–≤—è–∑–∏:", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "contact")
def send_to_admin(m):
    chat = m.chat.id
    contact = m.text
    data = SESS[chat]
    res = data["result"]
    
    admin_msg = (
        f"üîî *–ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê*\n"
        f"üë§ –ö–ª–∏–µ–Ω—Ç: {contact} (ID: {chat})\n"
        f"üìç {data['city']}, {data['layout']}, {data['service_type']}\n"
        f"üí∞ –ò—Ç–æ–≥–æ: {res['total']} TL\n"
        f"–î–µ—Ç–∞–ª–∏: {data}"
    )
    
    try:
        bot.send_message(ADMIN_ID, admin_msg)
        bot.send_message(chat, "‚úÖ –°–ø–∞—Å–∏–±–æ! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.", 
                         reply_markup=types.ReplyKeyboardMarkup(resize_keyboard=True).add("–°–¢–ê–†–¢"))
    except Exception as e:
        bot.send_message(chat, f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
    
    SESS.pop(chat, None)

@bot.message_handler(func=lambda m: True)
def default_msg(m):
    bot.send_message(m.chat.id, "–ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞.")

if __name__ == "__main__":
    print("Bot started...")
    bot.infinity_polling()