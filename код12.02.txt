# –î–æ–±–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ –∫ –¥—Ä—É–≥–∏–º CONFIG, –µ—Å–ª–∏ –µ—ë —Ç–∞–º –Ω–µ—Ç
INSTAGRAM_LINK = "https://www.instagram.com/cleanteam.antalya?igsh=amdxcnZlaGRqN3Vl&utm_source=qr"

# ---------- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê –ò –§–ò–ù–ê–õ–ê ----------

def calculate_total(chat_id):
    d = SESS.get(chat_id, {})
    srv = d.get("service_type")
    
    # 1. –ü–æ—á–∞—Å–æ–≤–∞—è
    if srv == "–ü–æ—á–∞—Å–æ–≤–∞—è":
        h, c = int(d.get("hours", 0)), int(d.get("cleaners", 1))
        total = max(h * c * HOURLY_RATE, MIN_TRAVEL_PER_PERSON * c)
        dist = DISTANCE_FEE.get(d.get("city"), 0) * c
        return {"total": int(total + dist), "is_hourly": True, "c": c, "h": h, "discount": 0}

    # 2. –û–±—ã—á–Ω–∞—è —É–±–æ—Ä–∫–∞
    l_key = d.get("layout")
    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–ª—é—á–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫—É—Ö–Ω—è, 2+1 –ø–ª–æ—â–∞–¥—å)
    if d.get("kitchen_isolated"):
        if l_key == "1+0": l_key = "1+1"
        elif l_key and l_key[0].isdigit() and int(l_key[0]) < 5: l_key = f"{int(l_key[0])+1}+1"
    
    if l_key == "2+1": 
        l_key = "2+1_low" if d.get("area") == "<100 –º¬≤" else "2+1_high"
    
    # –ë–∞–∑–∞ + –ö–æ–º–Ω–∞—Ç—ã + –î–æ–ø—ã
    bath = int(d.get("bathrooms", 1))
    balc = int(d.get("balconies", 1))
    rooms_fee = (max(0, bath-1)*400) + (max(0, balc-1)*200)
    
    ex_p, ex_t = 0, 0
    for n, q in d.get("extras", []):
        ex_p += EXTRAS[n]["price"] * q
        ex_t += EXTRAS[n]["time"] * q
        
    base_k = srv if srv != "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞" else "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è"
    rec_c, rec_h = RECOMM_TABLE.get(l_key, {}).get(base_k, (1, 4))
    total_h = rec_h + (ex_t / 60 / rec_c)
    
    base_price = PRICES.get(l_key, {}).get(base_k, 0)
    total_before = base_price + ex_p + rooms_fee
    
    if srv == "–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 
        total_before *= 2
    
    # –°–∫–∏–¥–∫–∏
    ds = d.get("discounts_selected", {})
    disc = 0
    if ds.get("first"): disc += min(total_before * 0.1, 1000)
    if ds.get("vac"): disc += min(total_before * 0.05, 250)
    
    # –§–∏–Ω–∞–ª
    disc_val = min(disc, MAX_DISCOUNT_TL)
    dist_f = DISTANCE_FEE.get(d.get("city"), 0) * rec_c
    final = max(total_before - disc_val, MIN_TRAVEL_PER_PERSON * rec_c) + dist_f
    
    return {
        "total": int(final), 
        "c": rec_c, 
        "h": round(total_h, 1), 
        "is_hourly": False,
        "discount": int(disc_val) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É–º–º—É —Å–∫–∏–¥–∫–∏ –¥–ª—è —á–µ–∫–∞
    }

# --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–ù–ê–õ–ê ---

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "disc")
def h_fin(m):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫–∏–¥–∫–∏, –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç—ã
    if m.text == "–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑": SESS[m.chat.id]["discounts_selected"]["first"] = True
    
    # –°—á–∏—Ç–∞–µ–º
    res = calculate_total(m.chat.id)
    SESS[m.chat.id]["res"] = res
    d = SESS[m.chat.id]
    
    # –§–û–†–ú–ò–†–£–ï–ú –ü–û–î–†–û–ë–ù–´–ô –ß–ï–ö
    report = ["üìã *–†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò:*"]
    report.append(f"üìç –ì–æ—Ä–æ–¥: {d.get('city')}")
    report.append(f"‚ú® –£—Å–ª—É–≥–∞: {d.get('service_type')}")
    
    if res['is_hourly']:
        report.append(f"‚è≥ –ß–∞—Å–æ–≤: {res['h']} | –ö–ª–∏–Ω–µ—Ä–æ–≤: {res['c']}")
    else:
        report.append(f"üè† –û–±—ä–µ–∫—Ç: {d.get('layout')}")
        # –ö—É—Ö–Ω—è
        k_status = "–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è" if d.get('kitchen_isolated') else "–°–æ–≤–º–µ—â–µ–Ω–Ω–∞—è"
        report.append(f"üçΩ –ö—É—Ö–Ω—è: {k_status}")
        # –ö–æ–º–Ω–∞—Ç—ã
        report.append(f"üõÅ –°–∞–Ω—É–∑–ª–æ–≤: {d.get('bathrooms')} | üåÖ –ë–∞–ª–∫–æ–Ω–æ–≤: {d.get('balconies')}")
        
        # –î–æ–ø—ã —Å–ø–∏—Å–∫–æ–º
        if d.get('extras'):
            report.append("\n‚ûï *–î–æ–ø. —É—Å–ª—É–≥–∏:*")
            for name, qty in d.get('extras'):
                report.append(f" ‚Ä¢ {name}: {qty} —à—Ç.")
    
    report.append(f"\n--- --- ---")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if res.get('discount', 0) > 0:
        report.append(f"üéÅ –°–∫–∏–¥–∫–∞: -{res['discount']} TL")
        
    report.append(f"üí∞ *–ò–¢–û–ì–û: {res['total']} TL*")
    report.append(f"‚è±Ô∏è –í—Ä–µ–º—è: ~{res['h']} —á. | üë• {res['c']} —á–µ–ª.")
    
    full_text = "\n".join(report)
    SESS[m.chat.id]["report_text"] = full_text # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–ª—è –∞–¥–º–∏–Ω–∞

    bot.send_message(m.chat.id, full_text, parse_mode="Markdown", 
                     reply_markup=types.ReplyKeyboardMarkup(resize_keyboard=True).add("‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", "üîÑ –ó–∞–Ω–æ–≤–æ"))

@bot.message_handler(func=lambda m: m.text == "‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑")
def h_phone(m):
    SESS[m.chat.id]["step"] = "phone"
    bot.send_message(m.chat.id, "üìû –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @username –¥–ª—è —Å–≤—è–∑–∏:", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda m: SESS.get(m.chat.id, {}).get("step") == "phone")
def h_send(m):
    cid = m.chat.id
    contact = m.text
    # –ë–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
    report = SESS[cid].get("report_text", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    
    # 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ê–î–ú–ò–ù–£ –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥
    adm_msg = f"üîî *–ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê*\nüë§ –ö–æ–Ω—Ç–∞–∫—Ç: {contact}\n\n{report}"
    try:
        bot.send_message(ADMIN_ID, adm_msg, parse_mode="Markdown")
    except Exception as e:
        logging.error(f"Admin send error: {e}")

    # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ö–õ–ò–ï–ù–¢–£ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å—Å—ã–ª–æ–∫
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üì∏ –ù–∞—à Instagram (–ê–∫—Ü–∏–∏)", url=INSTAGRAM_LINK))
    kb.add(types.InlineKeyboardButton("üí¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –≤ WhatsApp", url=WHATSAPP_LINK))
    
    success_text = (
        "‚úÖ *–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è.*\n\n"
        "–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à Instagram, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –Ω–∞—à–∏—Ö –∞–∫—Ü–∏–π –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π!\n"
        "–ê –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞—à–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É —Å–µ–π—á–∞—Å:"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–∞–º–∏
    bot.send_message(cid, success_text, parse_mode="Markdown", reply_markup=kb)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ä—Ç–∞
    bot.send_message(cid, "–î–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:", 
                     reply_markup=types.ReplyKeyboardMarkup(resize_keyboard=True).add("–°–¢–ê–†–¢"))
    SESS.pop(cid, None)

@bot.message_handler(func=lambda m: m.text == "üîÑ –ó–∞–Ω–æ–≤–æ")
def restart(m): h_start(m)